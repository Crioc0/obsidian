---
created: 2025-09-27 18:28
tags:
  - backend
  - express
---
# 202509271828
*Ссылка на StructureNote:* 
*Ссылка на исходник или контекст (если есть):* [ЯПрактикум](https://practicum.yandex.ru/learn/backend-nodejs/courses/16b47298-e20d-4fde-9619-1ab305039a00/sprints/564238/topics/7c96eb76-3d6b-4f26-8c50-71c3fa757f2b/lessons/c164011c-29b7-4b62-8c4a-692aa56bcf6c/)

Принято обрабатывать ошибки централизованно. Для этого нам потребуется:

1. добавить специальный мидлвар-обработчик,
2. пробросить ошибки контроллера в него,
3. описать собственные классы ошибок, внутри которых мы определим HTTP-статус ответа.

В Express для обработки ошибок используется специальный обработчик
```ts
app.use((err, req, res, next) => {
  // это обработчик ошибки
});
```
Чтобы обработчик сработал корректно, его необходимо определить последним, после всех `app.use`. Обычно это делают где-то в конце файла.

Чтобы пробросить ошибку в мидлвар, нужно передать ошибку в качестве параметра в next()

Чтобы повторно не объявлять повторяющиеся ошибки, такие как NotFoundError, можно сделать кастомные ошибки, унаследовав от стандартной ошибки и выставляет свойство `statusCode`
```ts
// errors/not-found-err.js

class NotFoundError extends Error {
  constructor(message) {
    super(message);
    this.statusCode = 404;
  }
}

module.exports = NotFoundError;
```
После создания конструктора `NotFoundError`, его можно импортировать в другие места кода и использовать вместе с инструкцией `throw`:

### Три важных правила централизованной обработки ошибок

**1. Всегда завершайте цепочки промисов блоком `catch`.**

Передавайте в `catch` функцию `next` и добавляйте обработчик ошибки где-то в конце app.js. Если цепочка промисов не завершена блоком `catch`, это приведёт к так называемому Unhandled promise rejection (англ. «необработанное отклонение промиса»). Если этого не сделать — Node завершит свою работу и приложение упадёт.

**2. Не используйте `throw` в завершающих блоках `catch`.**

`Throw` переводит обработку в следующий блок `catch`. Если использовать `throw` в последнем блоке `catch`, ему будет некуда переходить и возникнет “Unhandled promise rejection”.

**3. Если в обработчик пришла ошибка без статуса, возвращайте ошибку сервера.**

Пользователю необязательно знать внутреннюю кухню нашего сервера. Поэтому для всех необработанных ошибок выставляйте статус-код — 500.
### Связанные идеи:
* [[202509251537 Мидлвары в express]]
---

*Что стоит развить? Какие вопросы возникли?*