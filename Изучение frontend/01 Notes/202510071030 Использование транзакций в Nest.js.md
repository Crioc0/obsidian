---
created: 2025-10-07 10:30
tags:
  - nestjs
  - typeORM
  - уровень_1
repeat: spaced every day
due_at: 2025-10-24T06:00:00.000+03:00
---
# 202510071030 Использование транзакций в Nest.js

*Ссылка на StructureNote:*[[Nest.js]] [[TypeORM]]
*Ссылка на исходник или контекст (если есть):*

Есть несколько разных способов использовать транзакции в TypeORM. Однако в документации Nest рекомендуется использовать QueryRunner, поскольку он даёт максимальный контроль над выполнением. Выглядит это довольно просто:

```ts
@Injectable()
export class UserService {
  constructor(
    @InjectRepository(User)
    private readonly dataSource: DataSource,
    private readonly userRepository: Repository<User>,
  ) {}

async createMany(users: User[]) {
  const queryRunner = this.dataSource.createQueryRunner();

  await queryRunner.connect();
  await queryRunner.startTransaction();
  try {
    // Сохраняем всех пользователей
        await Promise.all(users.map((user)=>queryRunner.manager.save(user));
   
    await queryRunner.commitTransaction();
  } catch (err) {
    await queryRunner.rollbackTransaction();
  } finally {
    await queryRunner.release();
  }
}
```

В данном примере мы:

1. Добавляем `dataSource` в конструктор сервиса.
2. Получаем в нужной функции сервиса экземпляр `QueryRunner`.
3. Соединяемся с базой.
4. Начинаем транзакцию.
5. Записываем данные пользователей.
6. Применяем транзакцию.
7. Если в ходе сохранения возникли ошибки, откатываем транзакцию.
8. Освобождаем полученный в начале `QueryRunner`.

Важно отметить, что транзакции работают только для запросов, которые меняют данные, но не меняют структуру таблиц. Проще говоря, в рамках транзакции вы можете использовать `DELETE`, `UPDATE`, `SELECT`, `INSERT`, но не можете использовать `ALTER TABLE` или `CREATE TABLE`.

### Связанные идеи:

* [[202510201526 Транзакции]]

---

*Что стоит развить? Какие вопросы возникли?*
