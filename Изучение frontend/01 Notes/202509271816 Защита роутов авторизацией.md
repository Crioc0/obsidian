---
created: 2025-09-27 18:16
tags:
  - mongoose
  - backend
  - express
  - basic
  - authentication
repeat: spaced every day
due_at: 2025-10-24T06:00:00.000+03:00
hidden: false
---
# 202509271816 Защита роутов авторизацией

*Ссылка на StructureNote:*  [[02 Structure notes/Mongoose|Mongoose]]
*Ссылка на исходник или контекст (если есть):* [ЯПрактикум]()

Авторизация в приложении работает как мидлвар. Если предоставлен верный токен, запрос проходит на дальнейшую обработку. Иначе запрос переходит контроллеру, который возвращает клиенту сообщение об ошибке.

Сперва нужно извлечь JWT-токен из заголовка или cookie. После извлечения токена из запроса нужно убедиться, что пользователь прислал именно тот токен, который был выдан ему ранее. Такую проверку осуществляет метод `verify` модуля `jsonwebtoken`. Метод принимает на вход два параметра — токен и секретный ключ, которым этот токен был подписан.

Метод `jwt.verify` вернёт пейлоуд токена, если тот прошёл проверку. Если с токеном что-то не так, вернётся ошибка. Чтобы её обработать, нужно обернуть метод `jwt.verify` в `try...catch`.

Если токен прошел верификацию, то нужно записать пейлоуд в запрос req и вызвать next()

Чтобы защитить роут, можно вызвать мидлвар авторизации перед теми роутами, для которых требуется защита

### Пример такого решения

```ts
// middlewares/auth.ts
import jwt from 'jsonwebtoken';

export default (req: Request, res: Response, next: NextFunction) => {
  const { authorization } = req.headers;

  if (!authorization || !authorization.startsWith('Bearer ')) {
    return res
      .status(401)
      .send({ message: 'Необходима авторизация' });
  }

  const token = authorization.replace('Bearer ', '');
  let payload;
  
  try {
    payload = jwt.verify(token, 'some-secret-key');
  } catch (err) {
    return res
      .status(401)
      .send({ message: 'Необходима авторизация' });
  }

  req.user = payload; // записываем пейлоуд в объект запроса

  next(); // пропускаем запрос дальше
};
```

### Связанные идеи:

* [[202509251537 Мидлвары в express]]
* [[202509261232 Создание JWT-токенов в NodeJS]]

---

*Что стоит развить? Какие вопросы возникли?*
