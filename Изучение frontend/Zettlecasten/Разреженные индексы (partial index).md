2025 09 1610 28
Tags: #MongoDB 
###### Links: 
1) 
# Заметка
Разреженные, или частичные, индексы позволяют создавать индекс не для всех документов в коллекции, а только для тех, которые подходят под определённое условие. Для построения индексов и их хранения нужно время и место на диске, а разреженные индексы — компромисс: используем меньше ресурсов, но индексируем только часть коллекции.
```ts
db.posts.createIndex(
    { "author.name": 1, "createdAt": -1 },
    { "partialFilterExpression": { "author.name": "johndoe" } }
);
```
Тогда запросы, которые удовлетворяют условию, будут использовать индекс, а остальные нет:
```ts
// используется индекс
db.posts.find({ "author.name": "johndoe" });

// индекс не используется
db.posts.find({ "author.name": "janedoe" });
```
Для условия можно использовать ограниченный набор операторов и выражений:

1. `$eq`или упрощённую запись `{<field>: <value>}` («равно»),
2. `$gt` и `$gte` («больше» и «больше или равно»),
3. `$lt` и `$lte` («меньше», «меньше или равно»),
4. Проверку на существование поля `$exists: true` (только `true`, для `false` работать не будет),
5. Оператор `$type` (тип значения),
6. Логический оператор `$and`.

Операторы сравнения задают условие, при котором документ будет добавлен в индекс. Документы, для которых условие не выполняется, в него не попадут, и для них MongoDB не будет его использовать и при поиске.
```ts
db.users.createIndex(
    { "username": 1 },
    { "partialFilterExpression": { "age": { "$gte": 18 } } }
)

// индекс используется
db.users.find({ "age": { "$gte": 18 } });

// индекс также используется, так как условие >27 входит в условие >=18
db.users.find({ "age": { "$gt": 27 } });

// индекс не используется
db.users.find({ "age": { "$lt": 18 } });

// индекс не используется, так как он потенциально содержит не все искомые документы
db.users.find({ "age": { "$gt": 16 } });
```
Частичный индекс можно применять вместе с уникальным, но при этом уникальность значения будет поддерживаться только в документах, которые подходят под условие:
```ts
// пара (email, username) будет уникальной для документов, в которых registrationSource === 'email'
db.users.createIndex(
    { "email": 1, "username": 1 },
    { "partialFilterExpression": { "registrationSource": 'email' } }
);
```