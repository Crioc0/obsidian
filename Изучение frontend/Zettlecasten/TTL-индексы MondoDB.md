2025 09 1610 23
Tags: #MongoDB 
###### Links: 
1) 
# Заметка
При решении многих задач в программировании данные имеют ценность и актуальность лишь ограниченное время. Прогноз погоды, курсы валют и, конечно, сессии пользователей имеют содержательный смысл лишь некоторое время, а затем устаревают.

Мы можем отслеживать актуальность данных самостоятельно, но тогда нам потребуется описывать логику мониторинга и следить, чтобы наша служба мониторинга не упала, оставив нас с неактуальными данными.


Мы можем отслеживать актуальность данных самостоятельно, но тогда нам потребуется описывать логику мониторинга и следить, чтобы наша служба мониторинга не упала, оставив нас с неактуальными данными.

Благодаря TTL индексам, удаление таких документов из коллекции может происходить автоматически. TTL индекс можно создать только по полю, которое содержит дату или массив дат:
```ts
db.sessions.createIndex({ "createdAt": 1 }, { "expireAfterSeconds": DAY_IN_SECONDS });
```
Поле `createdAt` содержит дату создания сессии, а в опции `expireAfterSeconds` нужно передать количество секунд, после которого документ должен быть удалён. Таким образом, документ с сессией будет удалён через день после создания.

Если поле содержит массив дат, то для вычисления времени удаления будет использована самая ранняя
```ts
db.collection.createIndex({ "dates": 1 }, { "expireAfterSeconds": DAY_IN_SECONDS });

{
    // самая ранняя дата — 01.01.2020, поэтому документ будет удалён 02.01.2020
  "dates": [ISODate(2020-02-01), ISODate(2020-01-01)]
}
```
Если же поле не содержит дату или вообще не существует в документе, он не будет удалён.

Важно: наличие TTL индекса не гарантирует, что документ будет удалён точно после истечения времени жизни.

MongoDB запускает задачу на удаление таких документов каждую минуту, то есть документ может существовать ещё минуту после истечения времени. Время также может увеличиться, если сервер нагружен.