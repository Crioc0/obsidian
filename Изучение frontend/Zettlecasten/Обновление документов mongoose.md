2025 09 1818 42
Tags: #mongoose 
###### Links: 
1) 
# Заметка
При обновлении мы находим запись и меняем её свойства
- Обновление конкретной записи. Для этого есть метод `findByIdAndUpdate`, который принимает на вход идентификатор в строковом виде. Вторым параметром ему передают объект со свойствами, которые нужно обновить:
```ts
// routes/users.js

// ...

const User = require('../models/user');

router.patch('/:id', (req, res) => {
  // обновим имя найденного по _id пользователя
  User.findByIdAndUpdate(req.params.id, { name: 'Виктор Гусев' })
    .then(user => res.send({ data: user }))
    .catch(err => res.status(500).send({ message: 'Произошла ошибка' }));
});
```
- Поиск первого совпадения с запросом и обновление его. Для этого есть метод `findOneAndUpdate`, который принимает на вход два объекта: первый с параметрами поиска, второй — с данными, каковой нужно обновить.
```ts
// найти первое совпадение с полем name, равным "Евгения Сталеварова", и заменить имя на "Виктор Гусев"
User.findOneAndUpdate({ name: 'Евгения Сталеварова' }, { name: 'Виктор Гусев' });
```
- Поиск совпадения с запросом и преобразование его. Аналогично можно превратить всех Жень Сталеваровых в Викторов Гусевых методом `update`:
```ts
// найти все совпадения с полем name, равным "Евгения Сталеварова", и заменить имя на "Виктор Гусев"
User.update({ name: 'Евгения Сталеварова' }, { name: 'Виктор Гусев' });
```
Есть тонкость в работе методов обновления: по умолчанию параметр, который получает на вход обработчик then, — это документ до обновления:
Это можно исправить. Поэтому третьим аргументом методы обновления документов принимают объект опций. Нас интересуют три из них:


|Опция|Что значит|Значение по умолчанию|
|---|---|---|
||||
|new|передать обновлённый объект на вход обработчику then|false|
|runValidators|валидировать новые данные перед записью в базу|false|
|upsert|если документ не найден, создать его|false|
```ts
User.findByIdAndUpdate(
    req.params.id,
    { name: 'Виктор Гусев' },
    // Передадим объект опций:
    {
        new: true, // обработчик then получит на вход обновлённую запись
        runValidators: true, // данные будут валидированы перед изменением
        upsert: true // если пользователь не найден, он будет создан
    }
)
  .then(user => res.send({ data: user }))
  .catch(user => res.send({ "Данные не прошли валидацию. Либо произошло что-то совсем немыслимое" }));
```