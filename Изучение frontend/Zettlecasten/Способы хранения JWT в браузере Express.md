2025 09 2316 15
Tags: #express 
###### Links: 
1) 
# Заметка
Существует два основных подхода для хранения JWT в браузере: c использованием localStorage и кук.

Главное преимущество localStorage — простой API и удобство работы. Однако есть и недостатки. Самые существенные из них:

- Можно хранить только строки. Для хранения JS-объектов каждый раз придётся приводить их к строке.
- Синхронный характер работы.
- Данные, которые хранятся в localStorage, может получить любой скрипт страницы, даже загружаемый из стороннего источника. Это позволяет украсть JWT-токен, например, добавив злонамеренный код в популярную библиотеку или внедрив его в страницу при помощи XSS.

## Куки
Куки - фрагменты данных, относящихся к определённому домену
Чтобы записать данные в куки браузера, сервер должен отправить заголовок `Set-Cookie`
```ts
res.set('Set-Cookie', 'name=Стас');
```
Получив такой заголовок, браузер сохранит `name=value` в куках.

Вручную устанавливать куки неудобно. Зато это удобно делать в Express — тут для этого есть метод `res.cookie`:
```ts
res.cookie('name', 'Стас');
```
Метод `res.cookie` особенно удобен для отправки опций, контролирующих поведение кук. К примеру, куки являются сессионными по умолчанию. Когда пользователь закрывает страницу, они удаляются. Это поведение можно изменить, отправив опцию `maxAge`. Она хранит срок жизни куки:
```ts
// такая кука будет храниться час
res.cookie('name', 'Стас', { maxAge: 3600000 });

// а такая — 7 дней
res.cookie('name', 'Стас', { maxAge: 3600000 * 24 * 7 });
```
По умолчанию к кукам есть доступ из JavaScript. В отличии от localStorage, это можно изменить опцией `httpOnly`
```ts
// отправим токен, браузер сохранит его в куках

res
  .cookie('jwt', token, {
        // token - наш JWT токен, который мы отправляем
    maxAge: 3600000,
    httpOnly: true
  })
  .end(); // если у ответа нет тела, можно использовать метод end
```
JWT сохранится в куках, к которым у JavaScript-кода не будет доступа. Значит, токен украсть при XSS-атаке не получится.
## Говорим fetch отправлять куки
Мы сохранили данные в куках, у которых нет доступа из JS-кода, но запросы мы посылаем из JavaScript, используя `fetch`. Как быть? Браузер автоматически пошлёт куки, если фронтенд и бэкенд работают на одном домене. Если Express-сервер отвечает и за API, и за раздачу фронтенда, то куки будут отправлены.
Если фронтенд и бэкенд работают на разных доменах, например, фронтенд мы разместили на GitHub Pages, а бэкенд ещё где-то, то в fetch нужно включить опцию `credentials`:
```t
```