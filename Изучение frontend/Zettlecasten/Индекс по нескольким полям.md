2025 09 1609 10
Tags:  #mongodb
###### Links: 
1) 
# Заметка
Индекс по нескольким полям, или составной индекс, делает поиск по нескольким полям быстрее. Например, нам нужно найти все посты автора за определённую дату. Создадим индекс:
```ts
db.posts.createIndex({ "author.name": 1, "createdAt": -1 });
```
Индекс будет выглядеть так: по каждому значению `author.name` будет содержаться индекс по `createdAt`. В индексе по первому полю мы сможем искать документы по всей коллекции, а в индексе по второму — только по тем документам, которые отфильтрует первый индекс.

Порядок полей при создании индекса важен, потому что индекс по второму полю не используется в отрыве от первого. Но ничего не мешает нам создать второй индекс, где первое поле — `createdAt`. Это позволит быстро искать все посты за определённый период
```ts
db.posts.createIndex({ "createdAt": -1, "author.name": 1 });
```
Индекс будет выглядеть так: по каждому значению `author.name` будет содержаться индекс по `createdAt`. В индексе по первому полю мы сможем искать документы по всей коллекции, а в индексе по второму — только по тем документам, которые отфильтрует первый индекс.

Также важен порядок сортировки в индексе. Если при индексе по одному полю мы могли обходить его в любом порядке, то в составном вторичный и последующие индексы ограничивают выборку. Это значит, что в некоторых случаях MongoDB придётся делать сортировку при запросе, а не использовать ту, которая есть в индексе.
```ts
db.posts.createIndex({
    "author.name": 1,
    "createdAt": -1
});

// при сортировке первичного поля в указаном порядке, 
// а вторичного в противоположном, придётся потратить время на сортировку
db.posts.find({
    "author.name": "johndoe"
}).sort({
    "author.name": 1,
    "createdAt": 1
});

// при этом, если мы используем противоположное направление для обоих полей,
// дополнительную сортировку делать не нужно — MongoDB просто перевернёт выборку
db.posts.find({
    "author.name": "johndoe"
}).sort({
    "author.name": -1,
    "createdAt": 1
});
```
Количество полей в составном индексе может быть любым, хоть весь документ. Но так делать не стоит, потому что такой индекс будет занимать много памяти, а поиск всё равно будет неэффективным. В индексы стоит добавлять только те поля, по которым регулярно происходит поиск.