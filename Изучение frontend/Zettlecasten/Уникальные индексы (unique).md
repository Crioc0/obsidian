2025 09 1610 11
Tags: #MongoDB 
###### Links: 
1) 
# Заметка
Чтобы найти email в базе данных, придётся обойти всю коллекцию, то есть поиск выполнится за O(n) сравнений. Другая проблема — если код приложения поменяется или в нём обнаружится ошибка, мы не сможем гарантировать уникальность каждого пользователя в базе. Поэтому лучше обеспечить это на уровне БД — с помощью уникального индекса.

Поиск в индексе выполнится всего за O(logN) сравнений. Но главное — при попытке вставить в коллекцию значение email, которое уже существует, вернётся ошибка.

Вы уже знакомы с одним уникальным индексом — в MongoDB это индекс по полю `_id`. Чтобы создать уникальный индекс, нужно передать второй аргумент с опциями в метод `createIndex`:
```ts
db.users.createIndex({ "email": 1 }, { "unique": true });
```
Такое решение не требует от программиста ручной проверки уникальности значений. Даже если программист забудет написать проверку — БД выбросит ошибку.

Уникальным можно сделать не только индекс по одному полю, но и составной индекс. Например, пользователю можно регистрироваться несколько раз, используя свой почтовый адрес. Но при каждой регистрации должно быть выбрано уникальное имя пользователя. Для этого просто создадим индекс по полям `email` и `username`:

```ts
db.users.createIndex({ "email": 1, "username": 1 }, { "unique": true });
```
Многоключевые индексы тоже можно сделать уникальными, но уникальность будет поддерживаться не во всей коллекции, а в массиве:
```ts
await db.posts.createIndex({ "tags": 1 }, { "unique": 1 });

await db.posts.insertOne({ "title": "My cool post", "tags": [ "js" ] });

// ок, так как значения "ts" ещё нет в массиве
await db.posts.updateOne({ "title": "My cool post" }, { "$push": { "tags": "ts" } });

// вернёт ошибку
await db.posts.updateOne({ "title": "My cool post" }, { "$push": { "tags": "js" } });
```
Уникальность значения в массиве можно поддерживать и с применением оператора `$addToSet`. Но это не спасёт от ошибки в коде приложения или ситуации, когда другой скрипт добавит неуникальное значение.